<!DOCTYPE html>
<html>
<head>
    <title>Elaria Trip Segment Map</title>
    <style>
        /* Always set the map height explicitly to define the size of the div element that contains the map. */
        #map {
            height: 100%;
            width: 100%;
        }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent scrollbars from the iframe */
        }
        .info-window-content {
            font-family: Arial, sans-serif;
            font-size: 14px;
            padding: 10px;
        }
        .info-window-content h4 {
            margin-top: 0;
            margin-bottom: 5px;
            color: #333;
        }
        .info-window-content p {
            margin-bottom: 5px;
        }
        .info-window-content .reviews {
            margin-top: 10px;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }
        .info-window-content .review-item {
            margin-bottom: 8px;
        }
        .info-window-content .review-author {
            font-weight: bold;
        }
        .info-window-content .review-rating {
            color: gold;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <script>
        let map;
        let markers = []; // To store markers added by users
        let infoWindow;
        let currentSegmentLocation = null; // Store the initial segment location

        // Function to initialize the map
        async function initMap() {
            // Get API key from the parent window (Elaria app in Base44) if passed, otherwise use a placeholder
            // In a real Base44 scenario, you might need to find a way to securely pass this,
            // or directly embed it if Base44 allows for "secret" variables in custom code blocks.
            // For this example, replace 'YOUR_Maps_API_KEY' with your actual key.
            const API_KEY = 'AIzaSyCrD97YvWeDHHPDZYNAa40O4bTieq_PxdA'; 

            const { Map } = await google.maps.importLibrary("maps");
            const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
            const { Place, Review } = await google.maps.importLibrary("places"); // Import Places library

            // Initialize InfoWindow
            infoWindow = new google.maps.InfoWindow();

            // Default map center (can be overridden by segment data)
            const defaultCenter = { lat: 31.0461, lng: 34.8516 }; // Center of Israel

            map = new Map(document.getElementById("map"), {
                center: defaultCenter,
                zoom: 8,
                mapId: "DEMO_MAP_ID", // Replace with your Map ID if you use Cloud-based map styling
            });

            // --- Functionality: Immediately show a map of the selected segment location ---
            // This function will be called by the parent Elaria app
            window.setSegmentLocation = function(lat, lng, name = "Segment Location") {
                const location = { lat: parseFloat(lat), lng: parseFloat(lng) };
                currentSegmentLocation = location;

                map.setCenter(location);
                map.setZoom(14); // Zoom in on the specific segment location

                // Clear previous segment marker if any
                markers = markers.filter(marker => !marker.isSegmentLocation);

                const segmentMarker = new AdvancedMarkerElement({
                    map: map,
                    position: location,
                    title: name,
                    content: createMarkerContent(name, 'segment-marker'), // Custom styling for segment marker
                });
                segmentMarker.isSegmentLocation = true; // Mark this marker as the segment location
                markers.push(segmentMarker);

                // Open info window immediately for the segment location
                infoWindow.setContent(`<h4>${name}</h4><p>This is your selected segment location.</p>`);
                infoWindow.open(map, segmentMarker);

                // Load saved markers for this segment
                loadMarkers(generateSegmentId(lat, lng));
            };

            // --- Functionality: Option for users to add markers/labels to the map ---
            map.addListener("click", (event) => {
                const latLng = event.latLng;
                const markerTitle = prompt("Enter a label for this location (optional):");

                if (markerTitle !== null) { // If user didn't cancel the prompt
                    addMarker(latLng.lat(), latLng.lng(), markerTitle || "Custom Location");
                    saveMarkers(generateSegmentId(currentSegmentLocation.lat, currentSegmentLocation.lng));
                }
            });

            // --- Functionality: Option to view information about locations (e.g., location, reviews, details) ---
            async function addMarker(lat, lng, title) {
                const position = { lat: lat, lng: lng };
                const marker = new AdvancedMarkerElement({
                    map: map,
                    position: position,
                    title: title,
                    content: createMarkerContent(title), // Default styling for user-added markers
                });

                // Add click listener to display info window
                marker.addListener("click", async () => {
                    await displayLocationInfo(marker, position, Place, Review);
                });

                markers.push(marker);
            }

            // Helper function to create custom marker content
            function createMarkerContent(text, className = 'default-marker') {
                const element = document.createElement('div');
                element.className = 'custom-marker ' + className;
                element.style.padding = '5px 10px';
                element.style.backgroundColor = 'white';
                element.style.border = '1px solid #ccc';
                element.style.borderRadius = '5px';
                element.style.boxShadow = '0 2px 6px rgba(0,0,0,.3)';
                element.style.whiteSpace = 'nowrap';
                element.style.fontSize = '12px';
                element.style.fontWeight = 'bold';
                element.textContent = text;
                return element;
            }

            // Function to display location information and reviews
            async function displayLocationInfo(marker, position, Place, Review) {
                let contentString = '<div class="info-window-content"><h4>Loading...</h4></div>';
                infoWindow.setContent(contentString);
                infoWindow.open(map, marker);

                try {
                    // Use Geocoding to get address from LatLng
                    const geocoder = new google.maps.Geocoder();
                    const geocodeResult = await geocoder.geocode({ location: position });
                    let address = "Address not found.";
                    let placeId = null;

                    if (geocodeResult.results[0]) {
                        address = geocodeResult.results[0].formatted_address;
                        placeId = geocodeResult.results[0].place_id;
                    }

                    let reviewsHtml = '';
                    if (placeId) {
                        const place = new Place({ id: placeId });
                        await place.fetchFields({ fields: ['displayName', 'formattedAddress', 'reviews', 'rating'] });

                        if (place.reviews && place.reviews.length > 0) {
                            reviewsHtml = '<div class="reviews"><h5>Reviews:</h5>';
                            place.reviews.slice(0, 3).forEach(review => { // Show up to 3 reviews
                                reviewsHtml += `<div class="review-item">
                                    <span class="review-author">${review.authorAttribution.displayName}:</span>
                                    <span class="review-rating">${'‚≠ê'.repeat(Math.round(review.rating))}</span>
                                    <p>${review.text}</p>
                                </div>`;
                            });
                            reviewsHtml += '</div>';
                        } else {
                            reviewsHtml = '<div class="reviews"><p>No reviews available for this place.</p></div>';
                        }
                    } else {
                         reviewsHtml = '<div class="reviews"><p>No Place ID found for reviews.</p></div>';
                    }

                    contentString = `
                        <div class="info-window-content">
                            <h4>${marker.title}</h4>
                            <p><strong>Address:</strong> ${address}</p>
                            ${reviewsHtml}
                        </div>
                    `;
                    infoWindow.setContent(contentString);
                } catch (error) {
                    console.error("Error fetching place details:", error);
                    infoWindow.setContent('<div class="info-window-content"><h4>Error loading details.</h4><p>Please try again later.</p></div>');
                }
            }

            // --- Functionality: Save and Load Markers (Persistent Storage) ---
            function generateSegmentId(lat, lng) {
                // Create a unique ID for the segment based on its coordinates
                return `segment-${lat.toFixed(5)}-${lng.toFixed(5)}`;
            }

            function saveMarkers(segmentId) {
                const segmentMarkers = markers.filter(m => !m.isSegmentLocation).map(marker => ({
                    lat: marker.position.lat(),
                    lng: marker.position.lng(),
                    title: marker.title,
                }));
                localStorage.setItem(`mapMarkers_${segmentId}`, JSON.stringify(segmentMarkers));
            }

            async function loadMarkers(segmentId) {
                // Clear existing user-added markers before loading new ones
                markers.filter(m => !m.isSegmentLocation).forEach(marker => marker.setMap(null));
                markers = markers.filter(m => m.isSegmentLocation); // Keep only the segment location marker

                const savedMarkers = JSON.parse(localStorage.getItem(`mapMarkers_${segmentId}`));
                if (savedMarkers) {
                    for (const markerData of savedMarkers) {
                        await addMarker(markerData.lat, markerData.lng, markerData.title);
                    }
                }
            }
        }

        // Load the Google Maps JavaScript API
        // Replace 'YOUR_Maps_API_KEY' with your actual API key
        // Ensure 'libraries=marker,places' are included to use Advanced Markers and Places API
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=AIzaSyCrD97YvWeDHHPDZYNAa40O4bTieq_PxdA&callback=initMap&libraries=marker,places`;
        document.head.appendChild(script);

        // Listen for messages from the parent window (Elaria app in Base44)
        window.addEventListener('message', (event) => {
            // Ensure the message is from a trusted source if possible in Base44
            if (event.data && event.data.type === 'SET_SEGMENT_LOCATION') {
                const { lat, lng, name } = event.data.payload;
                window.setSegmentLocation(lat, lng, name);
            }
        });
    </script>
</body>
</html>
